#include "warp.h"
#include <rtthread.h>
#include <stm32l4xx.h>
#include <stdio.h>

static void warp_cipher(int argc, char *argv[])
{
    uint8_t X[32] = {0, 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 15, 14, 13, 12, 11, 10, 9, 8, 7, 6, 5, 4, 3, 2, 1, 0};
    uint8_t temp[32] = {0};
    uint8_t S[16] = {0xC, 0xA, 0xD, 0x3, 0xE, 0xB, 0xF, 0x7, 0x8, 0x9, 0x1, 0x5, 0x0, 0x2, 0x4, 0x6};
    uint8_t C[32] = {0x2, 0x4, 0xC, 0xE, 0x0, 0xA, 0x8, 0xE, 0xF, 0xD, 0x9, 0xF, 0x3, 0x2, 0xD, 0xE, 0x5, 0x2, 0x9, 0xD, 0x5, 0xF, 0xD, 0xF, 0x4, 0x5, 0x7, 0x0, 0x3, 0xA, 0x8, 0xD};
    uint8_t K0[16] = {0x0, 0x1, 0x2, 0x3, 0x4, 0x5, 0x6, 0x7, 0x8, 0x9, 0xA, 0xB, 0xC, 0xD, 0xE, 0xF};
    uint8_t K1[16] = {0xF, 0xE, 0xD, 0xC, 0xB, 0xA, 0x9, 0x8, 0x7, 0x6, 0x5, 0x4, 0x3, 0x2, 0x1, 0x0};
    uint8_t RC0s[41] = {0x0, 0x0, 0x1, 0x3, 0x7, 0xF, 0xF, 0xF, 0xE, 0xD, 0xA, 0x5, 0xA, 0x5, 0xB, 0x6, 0xC, 0x9, 0x3, 0x6, 0xD, 0xB, 0x7, 0xE, 0xD, 0xB, 0x6, 0xD, 0xA, 0x4, 0x9, 0x2, 0x4, 0x9, 0x3, 0x7, 0xE, 0xC, 0x8, 0x1, 0x2};
    uint8_t RC1s[41] = {0x4, 0xC, 0xC, 0xC, 0xC, 0xC, 0x8, 0x4, 0x8, 0x4, 0x8, 0x4, 0xC, 0x8, 0x0, 0x4, 0xC, 0x8, 0x4, 0xC, 0xC, 0x8, 0x4, 0xC, 0x8, 0x4, 0x8, 0x0, 0x4, 0x8, 0x0, 0x4, 0xC, 0xC, 0x8, 0x0, 0x0, 0x4, 0x8, 0x4, 0xC};
    uint8_t pi[32] = {11, 4, 9, 10, 13, 22, 1, 30, 7, 28, 15, 24, 5, 18, 3, 16, 27, 20, 25, 26, 29, 6, 17, 14, 23, 12, 31, 8, 21, 2, 19, 0};
    uint8_t index = {0};

    uint32_t start, end, elapsed;
    start = SysTick->VAL;

    // Your code Start

    for (size_t r = 0; r < 40; r++)
    {
        for (size_t i = 0; i < 16; i++)
        {
            X[2 * i + 1] ^= S[X[2 * i]];
        }
        for (size_t i = 0; i < 16; i++)
        {
            if ((r) % 2 == 0)
            {
                X[2 * i + 1] ^= K0[i];
            }
            else
            {
                X[2 * i + 1] ^= K1[i];
            }
        }
        X[1] = X[1] ^ RC0s[r];
        X[3] = X[3] ^ RC1s[r];
        for (size_t i = 0; i < 32; i++)
        {
            temp[i] = X[pi[i]];
        }
        for (size_t i = 0; i < 32; i++)
        {
            X[i] = temp[i];
        }
    }
    for (size_t i = 0; i < 16; i++)
    {
        X[2 * i + 1] ^= S[X[2 * i]] ^ K0[i];
    }
    X[1] = X[1] ^ RC0s[40];
    X[3] = X[3] ^ RC1s[40];

    // Your code End
    end = SysTick->VAL;

    elapsed = start > end ? (start - end) : (start + (SysTick->LOAD - end));
    for (size_t i = 0; i < 32; i++)
    {
        if (X[i] != C[i])
        {
            rt_kprintf("Error at %d\n", i);
        }
    }

    // printf("cipher %llx\n", X);
    rt_kprintf("Execution time: %lu cycles\n", elapsed);
}

MSH_CMD_EXPORT_ALIAS(warp_cipher, warp, warp cipher);